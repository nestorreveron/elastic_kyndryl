
Comandos √∫tiles para trabajar con √≠ndices en Elasticsearch desde curl. Los he agrupado por tareas comunes para que los tengas a mano. Todos los ejemplos usan tu nodo localhost:9200.
	
‚ö†Ô∏è Nota: Cambia los nombres de √≠ndice/alias seg√∫n tu entorno. En producci√≥n, cuidado con operaciones que bloquean (p. ej., delete, close, forcemerge).



üß™ Integridad y salud

	** Salud del cl√∫ster:
		curl -s 'http://localhost:9200/_cluster/health?pretty'
		
	** Estado del √≠ndice (routing, recovery):
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_stats/store,docs,segments?pretty'
		
	** Comprobar asignaci√≥n de shards:
		curl -s 'http://localhost:9200/_cat/allocation?v'
	
	** Estado detallado de los nodos del cl√∫ster
		curl -s 'http://localhost:9200/_cat/nodes?v'
	
	** Roles del cl√∫ster (ver roles por nodo)**
		curl -s 'http://localhost:9200/_cat/nodes?h=name,ip,node.role,master'
	
	** Informaci√≥n completa de nodos (JSON detallado)**
		curl -s 'http://localhost:9200/_nodes?pretty'

	** Versi√≥n
		curl -s http://localhost:9200/ | grep -E '"name"|"cluster_name"|"number"'



üëâ Monitorizar shards y su asignaci√≥n (routing allocation)**.

	** Ver el estado del cluster (shards incluidos)
		curl -s http://localhost:9200/_cluster/health?pretty

	** Ver la asignaci√≥n de shards por nodo
		curl -s http://localhost:9200/_cat/shards?v

	** Ver el **routing allocation** (decisiones del cluster)
		curl -s http://localhost:9200/_cluster/allocation/explain?pretty     --- la API /_cluster/allocation/explain necesita que le especifiques qu√© shard quieres analizar. Cuando hay shards sin asignar, puedes llamar a la API sin cuerpo;

	** Ver nodos y shards asignados
		curl -s http://localhost:9200/_cat/allocation?v

	** Ver shards sin asignar (unassigned)
		curl -s http://localhost:9200/_cat/shards?h=index,shard,state | grep UNASSIGNED

	** Ver configuraci√≥n de routing allocation
		curl -s http://localhost:9200/_cluster/settings?pretty



üìã Listado y exploraci√≥n

	** Listar todos los √≠ndices (tabla):
		curl -s 'http://localhost:9200/_cat/indices?v'
		
	** Solo nombres de √≠ndice:
		curl -s 'http://localhost:9200/_cat/indices?h=index'
		
	** Ordenados por tama√±o:
		curl -s 'http://localhost:9200/_cat/indices?v&s=store.size:desc'
		
	** Filtrar por patr√≥n (solo √≠ndices de usuario, sin punto inicial):
		curl -s 'http://localhost:9200/_cat/indices?h=index' | grep -vE '^.'
		
	** Detalles de shards por √≠ndice:
		curl -s 'http://localhost:9200/_cat/shards/logstash-ha-2025.12.10?v'
		
	** Ver segmentos (√∫til para diagnosticar rendimiento):
		curl -s 'http://localhost:9200/_cat/segments/logstash-ha-2025.12.10?v'
		
	** Estad√≠sticas del √≠ndice (docs, store, query cache, etc.):
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_stats?pretty'



üîé B√∫squeda y recuperaci√≥n de documentos

	** Buscar texto (full-text):
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_search?q=ERROR&size=10&pretty'
		
	** Buscar por campo exacto (message):
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_search?q=message:"ERROR probando logstash"&size=1&pretty'
		
	** √öltimo documento por @timestamp:
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_search?sort=@timestamp:desc&size=1&pretty'
		
	** Obtener por _id:
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_doc/<ID>?pretty'



üîç B√∫squedas avanzadas en Elasticsearch
Estas consultas permiten realizar b√∫squedas m√°s potentes y flexibles en tus √≠ndices.

### ‚úÖ **1. Fuzzy Search (b√∫squeda difusa)**

	** Busca t√©rminos similares tolerando errores tipogr√°ficos.

		curl -s -H 'Content-Type: application/json' -X POST "http://localhost:9200/logstash-ha-2025.12.10/_search" -d '{
		  "query": {
		    "fuzzy": {
		      "message": {
		        "value": "errror",
		        "fuzziness": 1,
		        "prefix_length": 1,
		        "max_expansions": 50
		      }
		    }
		  }
		}'


### ‚úÖ **2. Match con fuzziness autom√°tica**

	** Permite errores tipogr√°ficos con ajuste din√°mico.

		curl -s -H 'Content-Type: application/json' -X POST "http://localhost:9200/logstash-ha-2025.12.10/_search" -d '{
		  "query": {
		    "match": {
		      "message": {
		        "query": "Herrror",
		        "fuzziness": "AUTO"
		      }
		    }
		  }
		}'


*   `"AUTO"` ajusta la tolerancia seg√∫n la longitud del t√©rmino.
*   **`fuzziness`**: n√∫mero m√°ximo de ediciones permitidas (0, 1, 2).
*   **`prefix_length`**: caracteres iniciales que deben coincidir.
*   **`max_expansions`**: variaciones generadas.



### ‚úÖ **3. Wildcard Query**

	** Busca patrones con comodines (`*` para varios caracteres, `?` para uno).

		curl -s -H 'Content-Type: application/json' -X POST "http://localhost:9200/logstash-ha-2025.12.10/_search" -d '{
		  "query": {
		    "wildcard": {
		      "message": {
		        "value": "err*"
		      }
		    }
		  }
		}'


Ejemplo: `err*` coincide con `error`, `erroneo`, etc.



### ‚úÖ **4. Regexp Query**

	** Busca usando expresiones regulares.

	curl -s -H 'Content-Type: application/json' -X POST "http://localhost:9200/logstash-ha-2025.12.10/_search" -d '{
	  "query": {
	    "regexp": {
	      "message": "err.*"
	    }
	  }
	}'

Ejemplo: `err.*` coincide con cualquier palabra que empiece por `err`.


### ‚úÖ **5. Phrase Query (frase exacta)**

	** Busca documentos que contengan la frase exacta `"error cr√≠tico"`.

		curl -s -H 'Content-Type: application/json' -X POST "http://localhost:9200/logstash-ha-2025.12.10/_search" -d '{
		  "query": {
		    "match_phrase": {
		      "message": "error critico"
		    }
		  }
		}'


### ‚úÖ **6. Slop Query (frase flexible)**

	** Permite palabras intermedias entre los t√©rminos de la frase.

		curl -s -H 'Content-Type: application/json' -X POST "http://localhost:9200/logstash-ha-2025.12.10/_search" -d '{
		  "query": {
		    "match_phrase": {
		      "message": {
		        "query": "error cr√≠tico",
		        "slop": 3
		      }
		    }
		  }
		}'

*   `slop: 3` ‚Üí permite hasta 3 palabras entre `error` y `cr√≠tico`.



‚ú® **arrays** y **nested** en Elasticsearch: mapeos, indexaci√≥n, b√∫squedas, agregaciones y casos t√≠picos/pitfalls. Lo puedes copiar tal cual.

‚ö†Ô∏è Nota r√°pida: en Elasticsearch, **un array** es cualquier campo que recibe m√∫ltiples valores (nativos en JSON), y **`nested`** es un **tipo de mapeo** para arrays de objetos donde quieres preservar la relaci√≥n interna entre los atributos del mismo objeto. Si no usas `nested`, los objetos del array se **aplanan** y puedes obtener coincidencias cruzadas incorrectas (cross-object matching).


## Crear √≠ndice: arrays simples
	Los arrays no necesitan un tipo especial: basta con definir el campo y enviar m√∫ltiples valores.
	
		curl -s -X PUT "http://localhost:9200/products" -H "Content-Type: application/json" -d '
		{
		  "settings": { "number_of_shards": 1, "number_of_replicas": 0 },
		  "mappings": {
		    "properties": {
		      "name":   { "type": "text" },
		      "tags":   { "type": "keyword" },         // array de keywords
		      "prices": { "type": "float" },           // array de n√∫meros
		      "colors": { "type": "keyword" },         // array de strings
		      "created_at": { "type": "date" }
		    }
		  }
		}'



## Indexar documentos con arrays
	
		curl -s -X POST "http://localhost:9200/products/_doc/1" -H "Content-Type: application/json" -d '
		{
		  "name": "Zapatillas Trail",
		  "tags": ["deporte", "outdoor", "rebajas"],
		  "prices": [89.99, 79.99],
		  "colors": ["azul", "negro"],
		  "created_at": "2025-12-01T10:00:00Z"
		}'


		curl -s -X POST "http://localhost:9200/products/_doc/2" -H "Content-Type: application/json" -d '
		{
		  "name": "Camiseta T√©cnica",
		  "tags": ["deporte", "running"],
		  "prices": [29.99],
		  "colors": ["blanco"],
		  "created_at": "2025-12-02T09:30:00Z"
		}'



## Consultas sobre arrays

	** Filtrar documentos que contengan un valor en el array (tags contiene 'outdoor')
		curl -s -X GET "http://localhost:9200/products/_search" -H "Content-Type: application/json" -d '
		{
		  "query": { "term": { "tags": "outdoor" } }
		}'
	
	** Buscar cualquier color dentro del conjunto dado
		curl -s -X GET "http://localhost:9200/products/_search" -H "Content-Type: application/json" -d '
		{
		  "query": { "terms": { "colors": ["negro", "rojo"] } }
		}'
	
	** Rango sobre arrays (si prices tiene alg√∫n valor <= 80)
		curl -s -X GET "http://localhost:9200/products/_search" -H "Content-Type: application/json" -d '
		{
		  "query": { "range": { "prices": { "lte": 80 } } }
		}'


> ‚úÖ Arrays funcionan bien cuando los elementos son **valores simples** (strings/n√∫meros).  
> ‚ùå Si usas **arrays de objetos**, considera `nested`.



## Crear √≠ndice con campos `nested`

		curl -s -X PUT "http://localhost:9200/orders" -H "Content-Type: application/json" -d '
		{
		  "settings": { "number_of_shards": 1, "number_of_replicas": 0 },
		  "mappings": {
		    "properties": {
		      "customer_id": { "type": "keyword" },
		      "status":      { "type": "keyword" },
		      "items": {
		        "type": "nested",                      // << CLAVE: nested para array de objetos
		        "properties": {
		          "sku":      { "type": "keyword" },
		          "qty":      { "type": "integer" },
		          "price":    { "type": "float" },
		          "tags":     { "type": "keyword" },   // nested admite arrays internos
		          "shipping": {
		            "type": "nested",                  // nested dentro de nested (v√°lido)
		            "properties": {
		              "method": { "type": "keyword" },
		              "cost":   { "type": "float" }
		            }
		          }
		        }
		      },
		      "created_at": { "type": "date" }
		    }
		  }
		}'


## Indexar documentos con `nested`

	curl -s -X POST "http://localhost:9200/orders/_doc/1001" -H "Content-Type: application/json" -d '
	{
	  "customer_id": "CUST-001",
	  "status": "paid",
	  "items": [
	    {
	      "sku": "SKU-TRAIL-001",
	      "qty": 2,
	      "price": 79.99,
	      "tags": ["outdoor", "deporte"],
	      "shipping": [{ "method": "standard", "cost": 4.99 }]
	    },
	    {
	      "sku": "SKU-TEE-101",
	      "qty": 1,
	      "price": 29.99,
	      "tags": ["running"],
	      "shipping": [{ "method": "express", "cost": 7.99 }]
	    }
	  ],
	  "created_at": "2025-12-03T08:15:00Z"
	}'


## Consultas `nested` (con `inner_hits`)

	** Caso t√≠pico**: encontrar pedidos donde **el mismo elemento** (`items`) cumpla **sku = X** y **price < Y**. Sin `nested`, podr√≠as mezclar `sku` de un objeto con `price` 
	** de otro (resultado err√≥neo). Con `nested` se preserva el ‚Äúbloque‚Äù objeto.

		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{
		  "query": {
		    "nested": {
		      "path": "items",
		      "query": {
		        "bool": {
		          "must": [
		            { "term": { "items.sku": "SKU-TRAIL-001" } },
		            { "range": { "items.price": { "lt": 80 } } }
		          ]
		        }
		      },
		      "inner_hits": { "size": 10, "sort": [{ "items.price": "asc" }] }
		    }
		  }
		}'


	** Filtrar por atributo en nested anidado (`items.shipping.method`)**:

		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{
		  "query": {
		    "nested": {
		      "path": "items",
		      "query": {
		        "nested": {
		          "path": "items.shipping",
		          "query": { "term": { "items.shipping.method": "express" } },
		          "inner_hits": { "name": "shipping_hits" }
		        }
		      },
		      "inner_hits": { "name": "item_hits" }
		    }
		  }
		}'


	** B√∫squeda por arrays dentro de nested (tags)**:
	
		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{
		  "query": {
		    "nested": {
		      "path": "items",
		      "query": {
		        "terms": { "items.tags": ["deporte", "outdoor"] }
		      },
		      "inner_hits": { "size": 5 }
		    }
		  }
		}'

## Agregaciones sobre `nested`

	** Las agregaciones requieren entrar en el **contexto nested**.
	
		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{
		  "size": 0,
		  "aggs": {
		    "items_ctx": {
		      "nested": { "path": "items" },
		      "aggs": {
		        "by_sku": {
		          "terms": { "field": "items.sku", "size": 10 }
		        },
		        "avg_price": {
		          "avg": { "field": "items.price" }
		        }
		      }
		    }
		  }
		}'


	** Agregaci√≥n con filtro dentro de nested:
	
		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{
		  "size": 0,
		  "aggs": {
		    "items_ctx": {
		      "nested": { "path": "items" },
		      "aggs": {
		        "outdoor_items": {
		          "filter": { "terms": { "items.tags": ["outdoor"] } },
		          "aggs": {
		            "avg_price": { "avg": { "field": "items.price" } }
		          }
		        }
		      }
		    }
		  }
		}'


## Actualizaciones con `nested`
## Para actualizar un elemento `nested` espec√≠fico suele ser m√°s sencillo **reconstruir** el array en el lado cliente y reindexar el documento completo. No obstante, con `script` puedes manipular arrays:

	** A√±adir un nuevo item nested
		curl -s -X POST "http://localhost:9200/orders/_update/1001" -H "Content-Type: application/json" -d '
		{
		  "script": {
		    "source": "ctx._source.items.add(params.item)",
		    "lang": "painless",
		    "params": {
		      "item": {
		        "sku": "SKU-SOCK-555",
		        "qty": 3,
		        "price": 9.99,
		        "tags": ["running"],
		        "shipping": [{ "method": "standard", "cost": 2.99 }]
		      }
		    }
		  }
		}'


	** Actualizar una propiedad de un item que cumple condici√≥n:
		curl -s -X POST "http://localhost:9200/orders/_update/1001" -H "Content-Type: application/json" -d '
		{
		  "script": {
		    "source": """
		      for (int i = 0; i < ctx._source.items.size(); i++) {
		        if (ctx._source.items[i].sku == params.sku) {
		          ctx._source.items[i].price = params.newPrice;
		        }
		      }
		    """,
		    "lang": "painless",
		    "params": { "sku": "SKU-TRAIL-001", "newPrice": 74.99 }
		  }
		}'


‚ö†Ô∏è Si necesitas **actualizar por query** (`_update_by_query`) con `nested`, usa una consulta `nested` en el cuerpo `query` y scripts cuidadosos.

## Pitfalls y buenas pr√°cticas

1.  **Cross-object matching**: Si tienes arrays de objetos y no usas `nested`, las consultas `bool` pueden mezclar atributos de distintos objetos del array ‚Üí resultados incorrectos. Usa `type: nested`.
2.  **`inner_hits`**: Muy √∫til para ver qu√© sub-objetos nested han matcheado, sobre todo en UI y depuraci√≥n.
3.  **Performance**: Campos `nested` multiplican documentos internamente (cada objeto ser√° un doc ‚Äúhijo‚Äù). Evita nested profundos salvo que sean necesarios; considera denormalizar si no necesitas consultas conjuntas.
4.  **Orden de arrays**: Elasticsearch no preserva orden para prop√≥sitos de consulta (los arrays no son indexados con orden sem√°ntico).
5.  **Agregaciones**: Siempre entrar al contexto `nested` con la agregaci√≥n `nested`. Para volver al documento ra√≠z usa `reverse_nested` si necesitas correlacionar.
6.  **Actualizaciones**: Modificar elementos concretos dentro de un array nested con scripts puede ser costoso y complejo; reindexar el documento completo suele ser m√°s simple y seguro.
7.  **Mapping immutable**: No puedes cambiar un campo de `object` a `nested` en caliente. Planifica el mapeo desde el inicio.

	** Ejemplo de `reverse_nested`:
	
		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{
		  "size": 0,
		  "aggs": {
		    "items_ctx": {
		      "nested": { "path": "items" },
		      "aggs": {
		        "by_sku": {
		          "terms": { "field": "items.sku", "size": 10 },
		          "aggs": {
		            "back_to_root": {
		              "reverse_nested": {},
		              "aggs": {
		                "by_status": { "terms": { "field": "status" } }
		              }
		            }
		          }
		        }
		      }
		    }
		  }
		}'

** Comandos √∫tiles de depuraci√≥n

	# Ver mapping
		curl -s "http://localhost:9200/orders/_mapping?pretty"

	# Get por ID
		curl -s "http://localhost:9200/orders/_doc/1001?pretty"

	# Buscar con explicaci√≥n
		curl -s -X GET "http://localhost:9200/orders/_search" -H "Content-Type: application/json" -d '
		{ "explain": true, "query": { "match_all": {} } }'



‚úÖ Relevancia (relevance) y Scoring

## 1) √çndice y documentos de prueba

	** Crear √≠ndice simple
		curl -s -X PUT "http://localhost:9200/articles" -H "Content-Type: application/json" -d '
		{
		  "settings": { "number_of_shards": 1, "number_of_replicas": 0 },
		  "mappings": {
			"properties": {
			  "title":   { "type": "text" },
			  "content": { "type": "text" },
			  "tags":    { "type": "keyword" },
			  "popularity": { "type": "integer" }
			}
		  }
		}'

	** Indexar 3 documentos
		curl -s -X POST "http://localhost:9200/articles/_doc/1" -H "Content-Type: application/json" -d '
		{"title":"Gu√≠a de running en Madrid","content":"Correr por el Retiro y Casa de Campo","tags":["running","madrid"],"popularity": 50}'

		curl -s -X POST "http://localhost:9200/articles/_doc/2" -H "Content-Type: application/json" -d '
		{"title":"Mejores zapatillas para trail","content":"Consejos y pruebas en monta√±a","tags":["trail","zapatillas"],"popularity": 10}'

		curl -s -X POST "http://localhost:9200/articles/_doc/3" -H "Content-Type: application/json" -d '
		{"title":"Entrenamiento de running avanzado","content":"Series, t√©cnica y planificaci√≥n","tags":["running"],"popularity": 80}'

	** Forzar refresco
		curl -s -X POST "http://localhost:9200/articles/_refresh"


## 2) `match` vs `term` (an√°lisis vs coincidencia exacta)

	** match (analiza texto, BM25) - busca 'running'
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '
		{ "query": { "match": { "title": "running" } }, "_source": ["title"], "explain": true }'
	
	** term (exacto, no analiza) - √∫til para keywords
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '
		{ "query": { "term": { "tags": "running" } }, "_source": ["title","tags"], "explain": true }'

‚úÖ‚úÖ Observa los `scores` y en `explain` c√≥mo BM25 pondera frecuencia y rareza del t√©rmino. ‚úÖ‚úÖ


## 3) `multi_match` + `boost` (ponderar campos)

	** Ponderar el t√≠tulo m√°s que el contenido
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '
		{
		  "_source": ["title"],
		  "query": {
		    "multi_match": {
		      "query": "running",
		      "fields": ["title^2", "content"]   // ^2 = boost al t√≠tulo
		    }
		  }
		}'


‚úÖ‚úÖ Si ‚Äúrunning‚Äù aparece en `title`, sube m√°s el score que si solo est√° en `content`. ‚úÖ‚úÖ


## 4) `bool` con `should` y `minimum_should_match`

	** Varios criterios opcionales, pero exigimos que al menos 1 se cumpla
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '
		{
		  "_source": ["title","tags"],
		  "query": {
		    "bool": {
		      "should": [
		        { "match": { "title": "running" } },
		        { "term":  { "tags": "trail" } }
		      ],
		      "minimum_should_match": 1
		    }
		  }
		}'

‚úÖ‚úÖ Documentos que cumplan m√°s `should` tienden a puntuar mejor. ‚úÖ‚úÖ


## 5) `function_score` (combinar texto con popularidad)

	** Sumamos relevancia textual + boost por popularidad (campo num√©rico)
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '
		{
		  "_source": ["title","popularity"],
		  "query": {
		    "function_score": {
		      "query": { "match": { "content": "running" } },
		      "field_value_factor": {
		        "field": "popularity",
		        "factor": 1.0,
		        "modifier": "sqrt",   // suaviza el impacto
		        "missing": 0
		      },
		      "boost_mode": "sum",     // score_final = score_textual + factor(popularity)
		      "score_mode": "sum"
		    }
		  }
		}'

‚úÖ‚úÖ √ötil para re-ranking por m√©tricas de negocio (clics, ventas, likes‚Ä¶). ‚úÖ‚úÖ


## 6) `script_score` (control total del score)

	** Ejemplo simple: priorizar t√≠tulos que contengan 'running' y sumar popularidad
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source": ["title","tags","popularity"],
		  "query": {
		    "script_score": {
		      "query": { "match_all": {} },
		      "script": {
		        "source": "double bonus = doc[\"tags\"].contains(\"running\") ? 5.0 : 0.0; double pop = doc[\"popularity\"].size() > 0 ? doc[\"popularity\"].value : 0.0; return bonus + Math.sqrt(pop);"
		      }
		    }
		  }
		}'

‚úÖ‚úÖ Con `script_score` puedes implementar tu l√≥gica de negocio en Painless. √ösalo con moderaci√≥n (impacto en rendimiento). ‚úÖ‚úÖ





üìù Aplicar **boost** en consultas de Elasticsearch.
‚ö†Ô∏è Recuerda: los boosts influyen en el `_score`. Observa c√≥mo cambia el orden de resultados. ‚ö†Ô∏è


## 0) Dataset r√°pido (si no lo tienes cargado)

	** √çndice y docs de ejemplo
		curl -s -X PUT "http://localhost:9200/articles" -H "Content-Type: application/json" -d '{
		  "settings":{"number_of_shards":1,"number_of_replicas":0},
		  "mappings":{"properties":{
		    "title":{"type":"text","fields":{"keyword":{"type":"keyword"}}},
		    "content":{"type":"text"},
		    "tags":{"type":"keyword"},
		    "popularity":{"type":"integer"}
		  }}
		}'

curl -s -X POST "http://localhost:9200/articles/_doc/1" -H "Content-Type: application/json" -d '{"title":"Gu√≠a de running en Madrid","content":"Correr por el Retiro y Casa de Campo","tags":["running","madrid"],"popularity":50}'
curl -s -X POST "http://localhost:9200/articles/_doc/2" -H "Content-Type: application/json" -d '{"title":"Mejores zapatillas para trail","content":"Consejos y pruebas en monta√±a","tags":["trail","zapatillas"],"popularity":10}'
curl -s -X POST "http://localhost:9200/articles/_doc/3" -H "Content-Type: application/json" -d '{"title":"Entrenamiento de running avanzado","content":"Series, t√©cnica y planificaci√≥n","tags":["running"],"popularity":80}'
curl -s -X POST "http://localhost:9200/articles/_refresh"


## 1) **Field boost** con `multi_match` (`title^2`)

	** Da m√°s peso al t√≠tulo que al contenido.
	
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title"],
		  "query":{
		    "multi_match":{
		      "query":"running",
		      "fields":["title^2","content"]  // ^2 = el t√≠tulo punt√∫a el doble
		    }
		  }
		}'


## 2) **Boost a nivel de query** (`boost`)

	** Sube el peso de una cl√°usula espec√≠fica en un `bool`.
	
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title","tags"],
		  "query":{
		    "bool":{
		      "should":[
		        { "match": { "title": { "query":"running", "boost": 3.0 } } },
		        { "term":  { "tags":  { "value":"trail",   "boost": 1.0 } } }
		      ],
		      "minimum_should_match":1
		    }
		  }
		}'


## 3) **`boosting` query** (promueve positivos y deprime negativos)

	** Promueve documentos que coinciden con `running`, pero **penaliza** si adem√°s contienen `trail`.
	
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title","tags"],
		  "query":{
		    "boosting":{
		      "positive":{ "match":{ "content":"running" } },
		      "negative":{ "term": { "tags":"trail" } },
		      "negative_boost": 0.3
		    }
		  }
		}'


## 4) **`dis_max`** con boosts y `tie_breaker`

	** Devuelve el mejor score entre varias alternativas, con un peque√±o extra por coincidencias m√∫ltiples.
	
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title"],
		  "query":{
		    "dis_max":{
		      "queries":[
		        { "match":{ "title":   { "query":"running", "boost":2.0 } } },
		        { "match":{ "content": { "query":"running", "boost":1.0 } } }
		      ],
		      "tie_breaker": 0.2
		    }
		  }
		}'


## 5) **`function_score`** (texto + factor de negocio)

	** Reordena combinando BM25 con **popularidad** (ra√≠z cuadrada para suavizar).

		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title","popularity"],
		  "query":{
		    "function_score":{
		      "query":{ "match":{ "content":"running" } },
		      "field_value_factor":{
		        "field":"popularity",
		        "modifier":"sqrt",
		        "factor":1.0,
		        "missing":0
		      },
		      "boost_mode":"sum",
		      "score_mode":"sum"
		    }
		  }
		}'


## 6) **`script_score`** con bonus por `tags` y boost externo

	** Ejemplo estable (sin HTML ni comillas raras). Adem√°s, aplicamos un `boost` global a todo el `script_score`.

		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title","tags","popularity"],
		  "query":{
		    "script_score":{
		      "query":{ "match_all":{} },
		      "script":{
		        "source":"double bonus = doc[\"tags\"].contains(\"running\") ? 5.0 : 0.0; double pop = doc[\"popularity\"].size()>0 ? doc[\"popularity\"].value : 0.0; return bonus + Math.sqrt(pop);"
		      },
		      "boost": 1.5
		    }
		  }
		}'


## 7) **`constant_score`** con `boost` (√∫til para filtros)

	** Convierte coincidencias en **score uniforme** y lo controla con `boost`.
	
		curl -s -X GET "http://localhost:9200/articles/_search" -H "Content-Type: application/json" -d '{
		  "_source":["title","tags"],
		  "query":{
		    "constant_score":{
		      "filter":{ "term":{ "tags":"running" } },
		      "boost": 4.0
		    }
		  }
		}'


### Tip r√°pido
*   **Field boosts** (`^n`) y **query boosts** (`"boost": n`) son baratos y efectivos.
*   Para re-ranking avanzado, usa **`function_score`** y deja BM25 como base.
*   Evita `script_score` en vol√∫menes grandes si no es necesario (impacto en CPU).






üèóÔ∏è Creaci√≥n, borrado, apertura/cierre

	** Crear un √≠ndice (con settings b√°sicos):
		curl -s -X PUT 'http://localhost:9200/demo-index' -H 'Content-Type: application/json' -d '{
		  "settings": {
		    "numberofshards": 1,
		    "numberofreplicas": 1
		  }
		}'

		curl -s -X POST "http://localhost:9200/products/_doc/1" -H "Content-Type: application/json" -d '
		{
		  "name": "Zapatillas Trail",
		  "tags": ["deporte", "outdoor", "rebajas"],
		  "prices": [89.99, 79.99],
		  "colors": ["azul", "negro"],
		  "created_at": "2025-12-01T10:00:00Z"
		}'
		
		curl -s -X POST "http://localhost:9200/products/_doc/2" -H "Content-Type: application/json" -d '
		{
		  "name": "Camiseta T√©cnica",
		  "tags": ["deporte", "running"],
		  "prices": [29.99],
		  "colors": ["blanco"],
		  "created_at": "2025-12-02T09:30:00Z"
		}'


	** Borrar un √≠ndice (‚ö†Ô∏è irreversible):
		curl -s -X DELETE 'http://localhost:9200/demo-index'
	
	
	** Cerrar / abrir (libera recursos sin borrar datos):
		curl -s -X POST 'http://localhost:9200/demo-index/close'
		curl -s -X POST 'http://localhost:9200/demo-index/open'



üß± Mappings (esquema) y settings

	** Ver mapping:
		curl -s 'http://localhost:9200/logstash-ha-2025.12.10/_mapping?pretty'
	
	** Actualizar mapping (a√±adir campo con tipo):
		curl -s -X PUT 'http://localhost:9200/demo-index/mapping' -H 'Content-Type: application/json' -d '{
		  "properties": {
		    "loglevel": { "type": "keyword" },
		    "message":   { "type": "text" }
		  }
		}'
		
	** Ver settings:
		curl -s 'http://localhost:9200/demo-index/_settings?pretty'
	
	** Cambiar n√∫mero de r√©plicas (online):
		curl -s -X PUT 'http://localhost:9200/demo-index/settings' -H 'Content-Type: application/json' -d '{
		  "index": { "numberof_replicas": 1 }
		}'



ü™™ Aliases y reindex

	** Crear alias:
		curl -s -X POST 'http://localhost:9200/_aliases' -H 'Content-Type: application/json' -d '{
		  "actions": [
		    { "add": { "index": "logstash-ha-2025.12.10", "alias": "logs-ha" } }
		  ]
		}'
		
	** Ver aliases:
		Reindex (copiar datos de A ‚Üí B, opcionalmente con transformaciones):
		curl -s -X POST 'http://localhost:9200/_reindex' -H 'Content-Type: application/json' -d '{
		  "source": { "index": "logstash-ha-2025.12.10" },
		  "dest":   { "index": "logs-archived" }
		}'
	
	** Reindex con filtro (solo log_level: ERROR):
		curl -s -X POST 'http://localhost:9200/reindex' -H 'Content-Type: application/json' -d '{
		  "source": {
		    "index": "logstash-ha-2025.12.10",
		    "query": { "term": { "loglevel.keyword": "ERROR" } }
		  },
		  "dest": { "index": "logs-errors" }
		}'



üîÑ Rollover e ILM (gesti√≥n de vida del √≠ndice)
	
	** Definir alias + √≠ndice inicial para rollover:
		curl -s -X PUT 'http://localhost:9200/logs-write' -H 'Content-Type: application/json' -d '{
		  "aliases": { "logs-alias": { "iswriteindex": true } }
		}'
	
	** Rollover por tama√±o o n√∫mero de docs:
		curl -s -X POST 'http://localhost:9200/logs-alias/rollover' -H 'Content-Type: application/json' -d '{
		  "conditions": {
		    "maxsize": "1gb",
		    "max_docs": 1000000
		  }
		}'
	
	** Adjuntar pol√≠tica ILM a un √≠ndice (ejemplo):
		curl -s -X PUT 'http://localhost:9200/ilm/policy/logs-policy' -H 'Content-Type: application/json' -d '{
		  "policy": {
		    "phases": {
		      "hot":   { "actions": { "rollover": { "maxsize": "1gb", "maxage": "7d" } } },
		      "delete":{ "minage": "30d", "actions": { "delete": {} } }
		    }
		  }
		}'
	
		curl -s -X PUT 'http://localhost:9200/logstash-ha-2025.12.10/settings' -H 'Content-Type: application/json' -d '{
		  "index": {
		    "lifecycle": {
		      "name": "logs-policy",
		      "rolloveralias": "logs-alias"
		    }
		  }
		}'



üß∞ Mantenimiento (forcemerge, shrink, split)
	
	** Force merge (reduce segmentos; √∫til despu√©s de cargas masivas):
		curl -s -X POST 'http://localhost:9200/logstash-ha-2025.12.10/forcemerge?maxnum_segments=1'
	
	
	‚ö†Ô∏è Ejecutar con precauci√≥n; puede consumir IO y CPU.
	
	** Shrink (reducir shards; requiere √≠ndice cerrado y bloqueado):
		
		# preparar
		curl -s -X PUT 'http://localhost:9200/demo-index/settings' -H 'Content-Type: application/json' -d '{"index.blocks.write": true}'
		curl -s -X POST 'http://localhost:9200/demo-index/close'
		
		# shrink a 1 shard
		curl -s -X POST 'http://localhost:9200/demo-index/shrink/demo-index-shrinked' -H 'Content-Type: application/json' -d '{"settings": {"index.numberofshards": 1 }}'
		
		# reabrir y limpiar bloqueos
		curl -s -X POST 'http://localhost:9200/demo-index-shrinked/open'
		curl -s -X PUT 'http://localhost:9200/demo-index-shrinked/_settings' -H 'Content-Type: application/json' -d '{"index.blocks.write": false}'
	
	
	** Split (aumentar shards; requiere preparaci√≥n):
		
		# preparar: establecer n√∫mero de r√©plicas = 1, definir routing
		curl -s -X PUT 'http://localhost:9200/demo-index/settings' -H 'Content-Type: application/json' -d '{
		  "index": {
		    "numberofreplicas": 1,
		    "routing": { "allocation": { "include": { "name": "es-node-1" } } }
		  }
		}'
		curl -s -X POST 'http://localhost:9200/demo-index/close'
		curl -s -X POST 'http://localhost:9200/demo-index/split/demo-index-split' -H 'Content-Type: application/json' -d '{
		  "settings": { "index.numberofshards": 4 }
		}'
		curl -s -X POST 'http://localhost:9200/demo-index-split/_open'
	


üóÑÔ∏è Snapshots (backup/restore)
	
	** Listar repositorios de snapshot:
		curl -s 'http://localhost:9200/_snapshot?pretty'
	
	** Crear repositorio (filesystem):
		curl -s -X PUT 'http://localhost:9200/_snapshot/fs-repo' -H 'Content-Type: application/json' -d '{
		  "type": "fs",
		  "settings": { "location": "/mnt/es-backups", "compress": true }
		}'
	
	** Tomar snapshot de un √≠ndice:
		curl -s -X PUT 'http://localhost:9200/snapshot/fs-repo/snap-2025-12-10' -H 'Content-Type: application/json' -d '{
		  "indices": "logstash-ha-2025.12.10",
		  "ignoreunavailable": true,
		  "includeglobalstate": false
		}'
	
	** Restaurar snapshot:
		curl -s -X POST 'http://localhost:9200/snapshot/fs-repo/snap-2025-12-10/restore' -H 'Content-Type: application/json' -d '{
		  "indices": "logstash-ha-2025.12.10",
		  "renamepattern": "logstash-ha-(.*)",
		  "renamereplacement": "logstash-ha-restore-$1"
		}'
	


üßæ Bonus: usar Kibana Dev Tools (si tienes Kibana)

	En Kibana ‚Üí Dev Tools ‚Üí Console, puedes ejecutar los mismos comandos sin curl. Por ejemplo:
	
		GET cat/indices?v&s=store.size:desc
		GET logstash-ha-2025.12.10/search?q=ERROR&size=10
		POST _reindex
		{
		  "source": { "index": "logstash-ha-2025.12.10" },
		  "dest":   { "index": "logs-archived" }
		}
